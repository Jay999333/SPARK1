# Pour l'affichage des tag, encre, rapsberry pi
import plotly.graph_objects as go
from collections import defaultdict



,
        dcc.Tab(label="Network View", value="network")    
 
 
 
 
    if tab == "network":
        return html.Div([
            html.H3("Network Topology"),
            html.Div([
                html.Button("Refresh Network", id="refresh-network-btn", 
                           style={"marginBottom": "20px"}),
                dcc.Graph(id="network-graph", 
                         style={"height": "800px"}),
            ]),
            html.Div(id="network-legend", style={
                "marginTop": "20px",
                "padding": "15px",
                "border": "1px solid #ddd",
                "borderRadius": "5px",
                "backgroundColor": "#f9f9f9"
            }, children=[
                html.H4("Legend:"),
                html.Div([
                    html.Span("ðŸŸ¦ Raspberry Pi Device", style={"marginRight": "20px"}),
                    html.Span("ðŸŸ© Encre Device", style={"marginRight": "20px"}),
                    html.Span("ðŸŸ¢ Card with Access", style={"marginRight": "20px"}),
                    html.Span("ðŸ”´ Card without Access", style={"marginRight": "20px"}),
                ])
            ])
        ])


# -----------------------
# Callback: Network Topology Visualization
# -----------------------
@app.callback(
    Output("network-graph", "figure"),
    [Input("refresh-network-btn", "n_clicks"),
     Input("tabs", "value")]
)
def update_network_graph(n_clicks, active_tab):
    if active_tab != "network":
        return go.Figure()
    
    # Fetch topology data from the API endpoint
    with server.test_client() as client:
        response = client.get("/api/admin/network_topology")
        if response.status_code != 200:
            return go.Figure().add_annotation(
                text="Error loading network data",
                showarrow=False,
                font=dict(size=20)
            )
        topology = response.get_json()
    
    # Create network graph using Plotly
    fig = go.Figure()
    
    # Track positions for layout
    x_positions = []
    y_positions = []
    node_text = []
    node_colors = []
    node_sizes = []
    edge_x = []
    edge_y = []
    
    # Position Raspberry Pi devices on the left
    pi_devices = topology['pi_devices']
    pi_y_spacing = 100
    for i, pi in enumerate(pi_devices):
        x_positions.append(50)
        y_positions.append(i * pi_y_spacing + 200)
        node_text.append(f"Pi: {pi['id']}<br>{pi['description']}")
        node_colors.append('#4169E1' if pi['enabled'] else '#A9A9A9')  # Blue or Gray
        node_sizes.append(40)
    
    # Position Encre devices in the middle
    encre_devices = topology['encre_devices']
    encre_y_spacing = 80
    encre_x = 300
    
    for i, encre in enumerate(encre_devices):
        encre_y = i * encre_y_spacing + 150
        x_positions.append(encre_x)
        y_positions.append(encre_y)
        
        last_seen = encre['last_seen']
        if last_seen:
            from datetime import datetime
            last_seen_dt = datetime.fromisoformat(last_seen.replace('Z', '+00:00'))
            time_ago = datetime.utcnow() - last_seen_dt.replace(tzinfo=None)
            if time_ago.total_seconds() < 3600:
                status = "Online"
            elif time_ago.total_seconds() < 86400:
                status = "Recent"
            else:
                status = "Offline"
        else:
            status = "Unknown"
        
        node_text.append(f"Encre: {encre['id']}<br>Status: {status}<br>Cards: {len(encre['cards'])}")
        node_colors.append('#32CD32')  # Green
        node_sizes.append(35)
        
        # Connect Pi to Encre (assuming all Encre connect to first Pi for simplicity)
        if pi_devices:
            edge_x.extend([50, encre_x, None])
            edge_y.extend([200, encre_y, None])
        
        # Position cards on the right
        cards = encre['cards']
        card_x = 550
        card_y_start = encre_y - (len(cards) * 15) / 2
        
        for j, card in enumerate(cards):
            card_y = card_y_start + j * 30
            x_positions.append(card_x)
            y_positions.append(card_y)
            
            access_status = "âœ“ Access" if card['has_access'] else "âœ— No Access"
            active_status = "Active" if card['active'] else "Inactive"
            node_text.append(
                f"Card: {card['card_id']}<br>"
                f"Owner: {card['owner']}<br>"
                f"{active_status}<br>"
                f"{access_status}"
            )
            
            # Color based on access
            if card['has_access'] and card['active']:
                node_colors.append('#00FF00')  # Bright green - has access
            elif card['active']:
                node_colors.append('#FFA500')  # Orange - active but no rules
            else:
                node_colors.append('#FF0000')  # Red - inactive
            
            node_sizes.append(25)
            
            # Connect Encre to Card
            edge_x.extend([encre_x, card_x, None])
            edge_y.extend([encre_y, card_y, None])
    
    # Add edges
    fig.add_trace(go.Scatter(
        x=edge_x,
        y=edge_y,
        mode='lines',
        line=dict(color='#888', width=1),
        hoverinfo='none',
        showlegend=False
    ))
    
    # Add nodes
    fig.add_trace(go.Scatter(
        x=x_positions,
        y=y_positions,
        mode='markers+text',
        marker=dict(
            size=node_sizes,
            color=node_colors,
            line=dict(color='white', width=2)
        ),
        text=node_text,
        textposition="top center",
        hoverinfo='text',
        showlegend=False
    ))
    
    # Update layout
    fig.update_layout(
        title="Network Topology - Raspberry Pi, Encre Devices & Access Cards",
        showlegend=False,
        hovermode='closest',
        margin=dict(b=20, l=5, r=5, t=40),
        xaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
        yaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
        plot_bgcolor='white',
        height=800
    )
    
    return fig
